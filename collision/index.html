<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Simulador de Impacto de Meteoro - São Paulo</title>
    <script src="https://cesium.com/downloads/cesiumjs/releases/1.117/Build/Cesium/Cesium.js"></script>
    <link href="https://cesium.com/downloads/cesiumjs/releases/1.117/Build/Cesium/Widgets/widgets.css" rel="stylesheet">
    <style>
        html,
        body,
        #cesiumContainer {
            width: 100%;
            height: 100%;
            margin: 0;
            padding: 0;
            overflow: hidden;
        }

        #controls {
            position: absolute;
            top: 10px;
            left: 10px;
            background: rgba(42, 42, 42, 0.9);
            color: white;
            padding: 15px;
            border-radius: 8px;
            z-index: 1000;
            font-family: Arial, sans-serif;
            max-width: 300px;
        }

        #controls button {
            background: #ff4444;
            color: white;
            border: none;
            padding: 10px 15px;
            margin: 5px;
            border-radius: 5px;
            cursor: pointer;
            font-weight: bold;
        }

        #controls button:hover {
            background: #ff6666;
        }

        #impact-info {
            margin-top: 10px;
            font-size: 12px;
            line-height: 1.4;
        }
    </style>
</head>

<body>
    <div id="cesiumContainer"></div>

    <div id="controls">
        <h3>🌠 Simulador de Impacto de Meteoro</h3>
        <button onclick="simulateImpact()">🚀 Simular Impacto</button>
        <button onclick="resetSimulation()">🔄 Resetar</button>
        <div id="impact-info">
            <strong>Local:</strong> São Paulo, Brasil<br>
            <strong>Diâmetro do meteoro:</strong> 50m<br>
            <strong>Velocidade:</strong> 20 km/s<br>
            <strong>Energia:</strong> ~1 Megatons TNT<br>
            <br>
            <em>💡 Clique no mapa para escolher o alvo!</em>
        </div>
    </div>

    <script>
        // Token de acesso do Cesium ion
        Cesium.Ion.defaultAccessToken = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJqdGkiOiJjMGRkYjMwYy1lODg0LTQ3MTktOTBiNi02ZDI0YjRiNTcxNjIiLCJpZCI6MzQ3MjQ2LCJpYXQiOjE3NTk2MDg1NzN9.901R3lkV1aC6zsOj843KhI37YOCw7lOnqS8rHd4nVq8'; // <-- COLOQUE SEU TOKEN AQUI

        // --- PARÂMETROS DA CRATERA ELÍPTICA ---
        let craterMajorRadius = 1500;
        let craterMinorRadius = 1500;
        let craterDepth = 400;
        let craterRotation = 45;
        // --- NOVO PARÂMETRO DA CALOTA ---
        let craterCapCutoffHeight = 0; // Altura do corte na calota (0 = corta na metade horizontal)

        // Variáveis globais
        let viewer;
        let meteorEntity;
        let craterCapEntity;
        let explosionEntity;
        let impactZones = [];
        let SAO_PAULO = { longitude: -46.633, latitude: -23.55 }; // Agora pode ser alterado
        let craterCapClippingPlanes; // Para gerenciar os ClippingPlanes da calota
        let targetMarker = null; // Marcador do alvo selecionado

        // Legendas
        const labelAlpha = 0.9; // Transparência das labels
        const labelBrightness = 1.2; // Brilho das labels

        // Aguarda o DOM estar pronto
        document.addEventListener('DOMContentLoaded', async function () {
            try {
                viewer = new Cesium.Viewer('cesiumContainer', {
                    terrain: Cesium.Terrain.fromWorldTerrain(),
                    sceneModePicker: false, animation: false, timeline: false,
                });
                // Camada adicional de labels (nomes de cidades/estradas)
                const labelsLayer = viewer.imageryLayers.addImageryProvider(
                    new Cesium.OpenStreetMapImageryProvider({
                        url: 'https://cartodb-basemaps-a.global.ssl.fastly.net/light_only_labels/',
                        fileExtension: 'png',
                        credit: 'CartoDB'
                    })
                );
                labelsLayer.alpha = labelAlpha;
                labelsLayer.brightness = labelBrightness;

                viewer.cesiumWidget.creditContainer.style.display = "none";
                viewer.scene.globe.depthTestAgainstTerrain = true;

                viewer.camera.flyTo({
                    destination: Cesium.Cartesian3.fromDegrees(SAO_PAULO.longitude, SAO_PAULO.latitude, 80000),
                    orientation: { heading: Cesium.Math.toRadians(0.0), pitch: Cesium.Math.toRadians(-90.0), roll: 0.0 },
                    duration: 3
                });

                viewer.entities.add({
                    position: Cesium.Cartesian3.fromDegrees(SAO_PAULO.longitude, SAO_PAULO.latitude),
                    point: { pixelSize: 15, color: Cesium.Color.CYAN, outlineColor: Cesium.Color.WHITE, outlineWidth: 3, heightReference: Cesium.HeightReference.CLAMP_TO_GROUND }
                });

                // Adiciona handler de clique no mapa para escolher o alvo
                const handler = new Cesium.ScreenSpaceEventHandler(viewer.scene.canvas);
                handler.setInputAction(function (movement) {
                    const cartesian = viewer.camera.pickEllipsoid(movement.position, viewer.scene.globe.ellipsoid);
                    if (cartesian) {
                        const cartographic = Cesium.Cartographic.fromCartesian(cartesian);
                        const longitude = Cesium.Math.toDegrees(cartographic.longitude);
                        const latitude = Cesium.Math.toDegrees(cartographic.latitude);

                        // Atualiza posição do alvo
                        SAO_PAULO.longitude = longitude;
                        SAO_PAULO.latitude = latitude;

                        // Remove marcador anterior
                        if (targetMarker) {
                            viewer.entities.remove(targetMarker);
                        }

                        // Cria novo marcador
                        targetMarker = viewer.entities.add({
                            position: Cesium.Cartesian3.fromDegrees(longitude, latitude),
                            point: {
                                pixelSize: 20,
                                color: Cesium.Color.RED,
                                outlineColor: Cesium.Color.WHITE,
                                outlineWidth: 3,
                                heightReference: Cesium.HeightReference.CLAMP_TO_GROUND
                            },
                            label: {
                                text: '🎯 ALVO',
                                font: '14pt Arial',
                                pixelOffset: new Cesium.Cartesian2(0, -25),
                                fillColor: Cesium.Color.WHITE,
                                outlineColor: Cesium.Color.RED,
                                outlineWidth: 2,
                                style: Cesium.LabelStyle.FILL_AND_OUTLINE,
                                backgroundColor: Cesium.Color.RED.withAlpha(0.7),
                                backgroundPadding: new Cesium.Cartesian2(5, 5)
                            }
                        });

                        console.log('Alvo definido em:', longitude.toFixed(3), latitude.toFixed(3));
                    }
                }, Cesium.ScreenSpaceEventType.LEFT_CLICK);

            } catch (error) { console.error('Erro ao inicializar simulador:', error); }
        });

        // Função para simular o impacto do meteoro
        function simulateImpact() {
            resetSimulation();
            createMeteor();
            setTimeout(() => {
                createExplosion();
                removeMeteor();
            }, 3000);
            setTimeout(() => {
                const impactPosition = Cesium.Cartesian3.fromDegrees(SAO_PAULO.longitude, SAO_PAULO.latitude);
                createRealCrater(impactPosition, craterMajorRadius, craterMinorRadius, craterDepth, craterRotation);
                // --- CHAMANDO A NOVA FUNÇÃO DA CALOTA COM CORTE ---
                createCraterCap(impactPosition, craterMajorRadius, craterMinorRadius, craterDepth, craterCapCutoffHeight, craterRotation);
                removeExplosion();
            }, 4000);
            setTimeout(createDestructionZones, 6000);
        }

        // Função para criar a cratera elíptica (sem alterações)
        function createRealCrater(position, majorRadius, minorRadius, depth, rotation) {
            const clippingPlanes = [];
            const points = [];
            const numSides = 64;
            const rotAngle = Cesium.Math.toRadians(rotation);
            for (let i = 0; i < numSides; i++) {
                const angle = Cesium.Math.TWO_PI * (i / numSides);
                const x = majorRadius * Math.cos(angle);
                const y = minorRadius * Math.sin(angle);
                const rotatedX = x * Math.cos(rotAngle) - y * Math.sin(rotAngle);
                const rotatedY = x * Math.sin(rotAngle) + y * Math.cos(rotAngle);
                points.push(new Cesium.Cartesian2(rotatedX, rotatedY));
            }
            for (let i = 0; i < numSides; i++) {
                const nextIndex = (i + 1) % numSides;
                const midpoint = Cesium.Cartesian2.add(points[i], points[nextIndex], new Cesium.Cartesian2());
                Cesium.Cartesian2.multiplyByScalar(midpoint, 0.5, midpoint);
                const normal = Cesium.Cartesian2.subtract(points[nextIndex], points[i], new Cesium.Cartesian2());
                Cesium.Cartesian2.normalize(normal, normal);
                const temp = normal.x;
                normal.x = -normal.y;
                normal.y = temp;
                clippingPlanes.push(new Cesium.ClippingPlane(new Cesium.Cartesian3(normal.x, normal.y, 0.0), -Cesium.Cartesian2.magnitude(midpoint)));
            }
            clippingPlanes.push(new Cesium.ClippingPlane(new Cesium.Cartesian3(0.0, 0.0, -1.0), depth));
            viewer.scene.globe.clippingPlanes = new Cesium.ClippingPlaneCollection({
                planes: clippingPlanes,
                edgeWidth: 1.0,
                edgeColor: Cesium.Color.WHITE,
                modelMatrix: Cesium.Transforms.eastNorthUpToFixedFrame(position),
                enabled: true
            });
        }

        function resetSimulation() {
            if (meteorEntity) viewer.entities.remove(meteorEntity);
            if (explosionEntity) viewer.entities.remove(explosionEntity);
            if (craterCapEntity) viewer.entities.remove(craterCapEntity);

            meteorEntity = explosionEntity = craterCapEntity = null;

            impactZones.forEach(zone => viewer.entities.remove(zone));
            impactZones = [];

            if (viewer.scene.globe.clippingPlanes) {
                viewer.scene.globe.clippingPlanes.enabled = false;
                viewer.scene.globe.clippingPlanes = undefined;
            }
            // --- REMOVE OS CLIPPING PLANES DA CALOTA ---
            if (craterCapClippingPlanes) {
                viewer.scene.removeClippingPlaneCollection(craterCapClippingPlanes);
                craterCapClippingPlanes = null;
            }

            // Não remove o targetMarker para manter o alvo selecionado

            viewer.camera.flyTo({
                destination: Cesium.Cartesian3.fromDegrees(SAO_PAULO.longitude, SAO_PAULO.latitude, 80000),
                orientation: { heading: Cesium.Math.toRadians(0.0), pitch: Cesium.Math.toRadians(-90.0), roll: 0.0 },
                duration: 2
            });
        }

        // --- DEMAIS FUNÇÕES (SEM ALTERAÇÃO) ---
        function createDestroyedGroundTexture() { const canvas = document.createElement('canvas'); canvas.width = 512; canvas.height = 512; const ctx = canvas.getContext('2d'); const gradient = ctx.createRadialGradient(256, 256, 0, 256, 256, 256); gradient.addColorStop(0, '#1a0f0a'); gradient.addColorStop(.5, '#4a2c1a'); gradient.addColorStop(.9, '#8b5a3c'); ctx.fillStyle = gradient; ctx.fillRect(0, 0, 512, 512); ctx.strokeStyle = 'rgba(0, 0, 0, 0.8)'; ctx.lineWidth = 3; for (let i = 0; i < 30; i++) { ctx.beginPath(); ctx.moveTo(256 + Math.random() * 200 - 100, 256 + Math.random() * 200 - 100); ctx.lineTo(256 + Math.random() * 240 - 120, 256 + Math.random() * 240 - 120); ctx.stroke() } return canvas.toDataURL() }
        function createMeteor() { const startTime = viewer.clock.currentTime; const endTime = Cesium.JulianDate.addSeconds(startTime, 3, new Cesium.JulianDate()); const startPosition = Cesium.Cartesian3.fromDegrees(SAO_PAULO.longitude - 1, SAO_PAULO.latitude + 1, 15e4); const endPosition = Cesium.Cartesian3.fromDegrees(SAO_PAULO.longitude, SAO_PAULO.latitude, 0); const positionProperty = new Cesium.SampledPositionProperty(); positionProperty.addSample(startTime, startPosition); positionProperty.addSample(endTime, endPosition); meteorEntity = viewer.entities.add({ name: "Meteoro", position: positionProperty, point: { pixelSize: 35, color: Cesium.Color.ORANGE, outlineColor: Cesium.Color.RED, outlineWidth: 4, scaleByDistance: new Cesium.NearFarScalar(1e3, 2, 1e5, .5) }, path: { show: !0, leadTime: 0, trailTime: 2, width: 10, resolution: 1, material: new Cesium.PolylineGlowMaterialProperty({ glowPower: .5, color: Cesium.Color.ORANGE, taperPower: .7 }) }, label: { text: "☄️ METEORO", font: "12pt Arial", pixelOffset: new Cesium.Cartesian2(0, -30), fillColor: Cesium.Color.YELLOW, outlineColor: Cesium.Color.RED, outlineWidth: 2, style: Cesium.LabelStyle.FILL_AND_OUTLINE } }); viewer.camera.setView({ destination: Cesium.Cartesian3.fromDegrees(SAO_PAULO.longitude, SAO_PAULO.latitude, 6e4), orientation: { heading: Cesium.Math.toRadians(0), pitch: Cesium.Math.toRadians(-90), roll: 0 } }) }
        function removeMeteor() { if (meteorEntity) { viewer.entities.remove(meteorEntity); meteorEntity = null; } }
        function createExplosion() { explosionEntity = viewer.entities.add({ name: "Explosão", position: Cesium.Cartesian3.fromDegrees(SAO_PAULO.longitude, SAO_PAULO.latitude, 1e3), ellipse: { semiMinorAxis: 5e3, semiMajorAxis: 5e3, height: 1e3, material: new Cesium.ColorMaterialProperty(new Cesium.CallbackProperty(function (e, t) { const i = Math.sin(Cesium.JulianDate.secondsDifference(e, viewer.clock.currentTime) * 10) * .5 + .5; return Cesium.Color.ORANGE.withAlpha(i * .8) }, !1)), outline: !0, outlineColor: Cesium.Color.RED }, label: { text: "💥 IMPACTO!", font: "16pt Arial", pixelOffset: new Cesium.Cartesian2(0, -20), fillColor: Cesium.Color.WHITE, outlineColor: Cesium.Color.RED, outlineWidth: 2, style: Cesium.LabelStyle.FILL_AND_OUTLINE } }) }
        function removeExplosion() { if (explosionEntity) { viewer.entities.remove(explosionEntity); explosionEntity = null; } }
        function createDestructionZones() { const e = viewer.entities.add({ name: "Destruição Total", position: Cesium.Cartesian3.fromDegrees(SAO_PAULO.longitude, SAO_PAULO.latitude), ellipse: { semiMinorAxis: 5e3, semiMajorAxis: 5e3, material: Cesium.Color.RED.withAlpha(.3), outline: !0, outlineColor: Cesium.Color.DARKRED, outlineWidth: 3, heightReference: Cesium.HeightReference.CLAMP_TO_GROUND }, label: { text: "ZONA VERMELHA\nDestruição Total", font: "12pt Arial", pixelOffset: new Cesium.Cartesian2(0, -20), fillColor: Cesium.Color.WHITE, outlineColor: Cesium.Color.RED, outlineWidth: 2, style: Cesium.LabelStyle.FILL_AND_OUTLINE, backgroundColor: Cesium.Color.RED.withAlpha(.7), backgroundPadding: new Cesium.Cartesian2(5, 5) } }), t = viewer.entities.add({ name: "Destruição Severa", position: Cesium.Cartesian3.fromDegrees(SAO_PAULO.longitude, SAO_PAULO.latitude), ellipse: { semiMinorAxis: 15e3, semiMajorAxis: 15e3, material: Cesium.Color.ORANGE.withAlpha(.2), outline: !0, outlineColor: Cesium.Color.DARKORANGE, outlineWidth: 2, heightReference: Cesium.HeightReference.CLAMP_TO_GROUND }, label: { text: "ZONA LARANJA\nDestruição Severa", font: "12pt Arial", pixelOffset: new Cesium.Cartesian2(100, 50), fillColor: Cesium.Color.WHITE, outlineColor: Cesium.Color.ORANGE, outlineWidth: 2, style: Cesium.LabelStyle.FILL_AND_OUTLINE, backgroundColor: Cesium.Color.ORANGE.withAlpha(.7), backgroundPadding: new Cesium.Cartesian2(5, 5) } }), i = viewer.entities.add({ name: "Danos Moderados", position: Cesium.Cartesian3.fromDegrees(SAO_PAULO.longitude, SAO_PAULO.latitude), ellipse: { semiMinorAxis: 3e4, semiMajorAxis: 3e4, material: Cesium.Color.YELLOW.withAlpha(.15), outline: !0, outlineColor: Cesium.Color.GOLD, outlineWidth: 2, heightReference: Cesium.HeightReference.CLAMP_TO_GROUND }, label: { text: "ZONA AMARELA\nDanos Moderados", font: "12pt Arial", pixelOffset: new Cesium.Cartesian2(-100, 100), fillColor: Cesium.Color.BLACK, outlineColor: Cesium.Color.YELLOW, outlineWidth: 2, style: Cesium.LabelStyle.FILL_AND_OUTLINE, backgroundColor: Cesium.Color.YELLOW.withAlpha(.7), backgroundPadding: new Cesium.Cartesian2(5, 5) } }); impactZones.push(e, t, i); viewer.camera.flyTo({ destination: Cesium.Cartesian3.fromDegrees(SAO_PAULO.longitude, SAO_PAULO.latitude, 12e4), orientation: { heading: Cesium.Math.toRadians(0), pitch: Cesium.Math.toRadians(-90), roll: 0 }, duration: 3 }) }

    </script>
</body>

</html>